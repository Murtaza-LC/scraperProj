<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Marketplace Comparator</title>
<style>
  :root{
    --bg:#0b1020; --surface:#0f172a; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#22d3ee; --accent2:#7c3aed; --ok:#34d399; --warn:#f59e0b;
    --radius:16px; --shadow:0 12px 28px rgba(0,0,0,.35);
  }
  html,body{height:100%}
  body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial; background:var(--bg); color:var(--text)}
  .container{width:min(1200px,92%); margin:auto}
  header{position:sticky; top:0; backdrop-filter:blur(10px); background:#0b1020cc; border-bottom:1px solid rgba(255,255,255,.06); z-index:5}
  .nav{display:flex; gap:14px; align-items:center; justify-content:space-between; padding:14px 0}
  h1{margin:0; font-size:1.2rem}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  input,select,button{border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0b1428; color:var(--text); padding:10px 12px}
  button{cursor:pointer; font-weight:800}
  .btn{background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#08111f; border:none}
  main{padding:22px 0 36px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.1); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
  .head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
  .list{display:grid; grid-template-columns:1fr; gap:10px; max-height:480px; overflow:auto}
  .item{display:grid; grid-template-columns:72px 1fr auto; gap:10px; align-items:center; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.08)}
  .item img{width:72px; height:72px; object-fit:contain; background:#0b1428; border-radius:10px}
  .name{font-weight:800; font-size:.95rem}
  .muted{color:var(--muted); font-size:.85rem}
  .price{font-variant-numeric:tabular-nums; font-weight:900}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  .tag{padding:4px 8px; border:1px solid rgba(255,255,255,.18); border-radius:999px; font-size:.75rem}
  .match-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .compare{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .pill{border:1px solid rgba(255,255,255,.18); border-radius:999px; padding:6px 10px; font-weight:800; cursor:pointer}
  .toolbar{display:flex; gap:10px; flex-wrap:wrap}
  .stretch{flex:1}
</style>
</head>
<body>
<header>
  <div class="container nav">
    <h1>Amazon ↔ Flipkart Comparator</h1>
    <div class="row" style="width:100%">
      <input id="amazonUrl" class="stretch" placeholder="Amazon listing URL (e.g., https://www.amazon.in/s?k=trending+mobile+phones)"/>
      <input id="flipkartUrl" class="stretch" placeholder="Flipkart listing URL (e.g., https://www.flipkart.com/search?q=trending+mobile+phones)"/>
      <select id="maxPages">
        <option value="1">Pages: 1</option>
        <option value="2">Pages: 2</option>
        <option value="3">Pages: 3</option>
      </select>
      <label class="row" style="gap:6px"><input id="pdp" type="checkbox"/> Enrich PDP</label>
      <button id="run" class="btn">Scrape</button>
    </div>
  </div>
</header>

<main class="container">
  <section class="card" style="margin-bottom:16px">
    <div class="toolbar">
      <span class="pill" data-sort="discount">Most discount</span>
      <span class="pill" data-sort="lowest">Lowest price</span>
      <span class="pill" data-sort="highest">Highest price</span>
      <span class="pill" data-sort="reviews">Most reviews</span>
      <input id="search" class="stretch" placeholder="Search products (e.g., 5G, 256GB, Samsung)"/>
    </div>
  </section>

  <section class="card" style="margin-bottom:16px">
    <div class="head"><strong>Matches (Amazon ↔ Flipkart)</strong><span id="matchCount" class="muted"></span></div>
    <div id="matches" class="match-grid"></div>
  </section>

  <div class="grid">
    <section class="card">
      <div class="head"><strong>Amazon</strong><span id="countAmazon" class="muted"></span></div>
      <div id="listAmazon" class="list"></div>
    </section>
    <section class="card">
      <div class="head"><strong>Flipkart</strong><span id="countFlipkart" class="muted"></span></div>
      <div id="listFlipkart" class="list"></div>
    </section>
  </div>
</main>

<script>
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

let rows = []; // unified rows from backend
let filtered = []; // after search/sort
let matches = [];  // matched pairs

// Normalize names for fuzzy matching
function normName(s){
  if(!s) return "";
  return s.toLowerCase()
    .replace(/[^a-z0-9\s\+]/g," ")
    .replace(/\b(5g|4g|smartphone|phone|android|mobile|gb|ram|rom)\b/g," ")
    .replace(/\s+/g," ")
    .trim();
}

// Simple token overlap score
function scoreMatch(a,b){
  const A = new Set(normName(a).split(" ").filter(Boolean));
  const B = new Set(normName(b).split(" ").filter(Boolean));
  if(!A.size || !B.size) return 0;
  let inter = 0;
  for(const t of A) if(B.has(t)) inter++;
  return inter / Math.min(A.size, B.size);
}

function renderLists(){
  const amz = filtered.filter(r=>r.platform==="amazon");
  const flk = filtered.filter(r=>r.platform==="flipkart");
  $('#countAmazon').textContent = `${amz.length} items`;
  $('#countFlipkart').textContent = `${flk.length} items`;
  $('#listAmazon').innerHTML = amz.map(viewItem).join("");
  $('#listFlipkart').innerHTML = flk.map(viewItem).join("");
}

function priceView(p){ return p!=null ? `₹${Number(p).toLocaleString('en-IN')}` : "—"; }

function viewItem(r){
  const img = r.image_url ? `<img src="${r.image_url}" alt="">` : `<img alt="">`;
  const disc = r.discount_percent!=null ? `<span class="tag">${r.discount_percent}% off</span>` : ``;
  const rev  = r.review_count!=null ? `<span class="tag">${r.review_count} reviews</span>` : ``;
  return `
  <a class="item" href="${r.product_url}" target="_blank" rel="noopener">
    ${img}
    <div>
      <div class="name">${r.product_name || '(No title)'}</div>
      <div class="muted">${r.brand_guess || ''}</div>
      <div class="muted">${r.platform}</div>
      <div class="row" style="gap:8px; margin-top:6px">${disc}${rev}</div>
    </div>
    <div style="text-align:right">
      <div class="price">${priceView(r.price)}</div>
      <div class="muted" style="text-decoration:line-through">${r.mrp?priceView(r.mrp):''}</div>
    </div>
  </a>`;
}

function viewMatch(pair){
  const a = pair.amazon, f = pair.flipkart;
  const delta = (a.price!=null && f.price!=null) ? (f.price - a.price) : null;
  const deltaTxt = delta==null ? '' :
    `<span class="${delta<0?'ok':'warn'}">${delta<0?'↓':'↑'} ₹${Math.abs(delta).toLocaleString('en-IN')}</span>`;
  return `
  <div class="compare card">
    <div>
      <div class="row" style="justify-content:space-between"><strong>Amazon</strong><a class="tag" href="${a.product_url}" target="_blank">Open</a></div>
      <div class="name">${a.product_name}</div>
      <div class="muted">${a.brand_guess||''}</div>
      <div class="price">${priceView(a.price)} <span class="muted" style="text-decoration:line-through">${a.mrp?priceView(a.mrp):''}</span></div>
      <div class="muted">${a.discount_percent!=null? a.discount_percent + '% off' : ''}</div>
    </div>
    <div>
      <div class="row" style="justify-content:space-between"><strong>Flipkart</strong><a class="tag" href="${f.product_url}" target="_blank">Open</a></div>
      <div class="name">${f.product_name}</div>
      <div class="muted">${f.brand_guess||''}</div>
      <div class="price">${priceView(f.price)} <span class="muted" style="text-decoration:line-through">${f.mrp?priceView(f.mrp):''}</span></div>
      <div class="muted">${f.discount_percent!=null? f.discount_percent + '% off' : ''}</div>
    </div>
    <div class="row" style="grid-column:1/-1; justify-content:flex-end; gap:8px">
      ${deltaTxt}
    </div>
  </div>`;
}

function computeMatches(){
  const A = filtered.filter(r=>r.platform==="amazon");
  const F = filtered.filter(r=>r.platform==="flipkart");
  const out = [];
  // Index Flipkart by brand to narrow comparisons
  const byBrand = new Map();
  for(const f of F){
    const key = (f.brand_guess||'').toLowerCase();
    if(!byBrand.has(key)) byBrand.set(key, []);
    byBrand.get(key).push(f);
  }
  for(const a of A){
    const candidates = (byBrand.get((a.brand_guess||'').toLowerCase())||F);
    let best=null, bestScore=0;
    for(const f of candidates){
      const s = scoreMatch(a.product_name||'', f.product_name||'');
      if(s>bestScore){ bestScore=s; best={amazon:a, flipkart:f}; }
    }
    if(best && bestScore>=0.55){ // threshold; tweak if needed
      out.push(best);
    }
  }
  // Deduplicate on Flipkart URL to keep one best match each side
  const seenF = new Set(); const dedup=[];
  for(const m of out){
    if(seenF.has(m.flipkart.product_url)) continue;
    seenF.add(m.flipkart.product_url); dedup.push(m);
  }
  matches = dedup;
  $('#matchCount').textContent = `${matches.length} pairs`;
  $('#matches').innerHTML = matches.map(viewMatch).join("");
}

function applySearchAndSort(){
  const term = ($('#search').value||'').toLowerCase();
  filtered = rows.filter(r=> !term || (r.product_name||'').toLowerCase().includes(term));
  renderLists();
  computeMatches();
}

function sortBy(mode){
  const key = {
    discount: (r)=> (r.discount_percent==null ? -Infinity : r.discount_percent),
    lowest:   (r)=> (r.price==null ? Infinity : r.price) * -1, // we'll reverse
    highest:  (r)=> (r.price==null ? -Infinity : r.price),
    reviews:  (r)=> (r.review_count==null ? -Infinity : r.review_count),
  }[mode];

  // Sort per platform independently for better UX in side panes:
  function sortPlatform(p){
    const arr = filtered.filter(r=>r.platform===p);
    arr.sort((a,b)=> (key(b)-key(a))); // desc by default
    if(mode==='lowest'){ arr.reverse(); } // now asc
    return arr;
  }
  const amz = sortPlatform('amazon');
  const flk = sortPlatform('flipkart');
  filtered = amz.concat(flk);
  renderLists();
  computeMatches();
}
function normalizeInputUrl(u) {
  if (!u) return "";
  u = u.trim();
  if (!u) return "";
  // Add https:// if user pasted without scheme
  if (!/^https?:\/\//i.test(u)) u = "https://" + u.replace(/^\/+/, "");
  try {
    // Validate and rebuild to ensure no stray whitespace
    const url = new URL(u);
    // Important: keep '+' literally in search, don’t let it become space.
    // URLSearchParams encodes '+' to '%2B' which is fine for Amazon/Flipkart.
    // Rebuild query to be safe:
    if (url.search) {
      const params = new URLSearchParams(url.search);
      url.search = "?" + params.toString();
    }
    return url.toString();
  } catch {
    return "";
  }
}

async function run(){
  let amazon = normalizeInputUrl($('#amazonUrl').value);
  let flip   = normalizeInputUrl($('#flipkartUrl').value);
  if(!amazon && !flip){
    alert('Enter at least one valid listing URL (Amazon or Flipkart).');
    return;
  }
  $('#run').disabled = true; $('#run').textContent = 'Scraping...';
  try{
    const qs = new URLSearchParams({
      amazon_url: amazon || '',
      flipkart_url: flip || '',
      max_pages: $('#maxPages').value,
      pdp_prices: $('#pdp').checked ? '1' : '0'
    });
    const res = await fetch(`/.netlify/functions/scrape?${qs.toString()}`);
    const json = await res.json();
    if(!json.ok) throw new Error(json.error || 'Unknown error');
    rows = json.rows || [];
    filtered = rows.slice();
    applySearchAndSort();
  }catch(err){
    alert('Scrape failed: ' + err.message);
  }finally{
    $('#run').disabled = false; $('#run').textContent = 'Scrape';
  }
}

// Event wiring
$('#run').addEventListener('click', run);
$('#search').addEventListener('input', applySearchAndSort);
$$('.pill').forEach(p => p.addEventListener('click', ()=> sortBy(p.dataset.sort)));
</script>
</body>
</html>
